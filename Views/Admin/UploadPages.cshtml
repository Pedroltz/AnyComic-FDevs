@model AnyComic.Models.Manga

@{
    ViewData["Title"] = $"Upload Pages - {Model.Titulo}";
}

<div class="container">
    <h1 class="mb-4">Upload Pages - @Model.Titulo</h1>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Warning"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            @TempData["Warning"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Manga Details -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    @if (!string.IsNullOrEmpty(Model.ImagemCapa))
                    {
                        <img src="@Model.ImagemCapa" class="img-fluid rounded" alt="@Model.Titulo">
                    }
                </div>
                <div class="col-md-9">
                    <h3>@Model.Titulo</h3>
                    <p><strong>Author:</strong> @Model.Autor</p>
                    <p><strong>Release Date:</strong> @Model.DataCriacao.ToString("dd/MM/yyyy")</p>
                    <p><strong>Description:</strong> @Model.Descricao</p>
                    <p><strong>Total Chapters:</strong> @Model.Capitulos.Count</p>
                    <p><strong>Total Pages:</strong> @Model.Paginas.Count</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chapter Management Section -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Chapters</h5>
        </div>
        <div class="card-body">
            <!-- Create New Chapter Form -->
            <div class="mb-4">
                <h6>Create New Chapter</h6>
                <form method="post" asp-controller="Admin" asp-action="CreateCapitulo" class="row g-3">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="mangaId" value="@Model.Id" />
                    <div class="col-md-8">
                        <input type="text" class="form-control" name="nomeCapitulo" placeholder="Custom chapter name (optional)">
                        <div class="form-text">Leave empty to auto-generate "Chapter X"</div>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-success w-100">Add Chapter</button>
                    </div>
                </form>
            </div>

            <!-- Chapters List -->
            @if (Model.Capitulos.Any())
            {
                <h6>Existing Chapters</h6>
                <div class="list-group">
                    @foreach (var capitulo in Model.Capitulos.OrderBy(c => c.NumeroCapitulo))
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <h6 class="mb-1">@capitulo.NomeExibicao</h6>
                                    <small class="text-muted">@capitulo.Paginas.Count page(s) | Created: @capitulo.DataCriacao.ToString("dd/MM/yyyy")</small>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#editChapter@(capitulo.Id)">
                                        Edit
                                    </button>
                                    <form method="post" asp-controller="Admin" asp-action="DeleteCapitulo" asp-route-id="@capitulo.Id" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure? This will delete all pages in this chapter!')">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- Edit Form (Collapsible) -->
                            <div class="collapse" id="editChapter@(capitulo.Id)">
                                <form method="post" asp-controller="Admin" asp-action="EditCapitulo" class="mt-2">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@capitulo.Id" />
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="nomeCapitulo" value="@capitulo.NomeCapitulo" placeholder="Enter custom name or leave empty">
                                        <button type="submit" class="btn btn-success">Save</button>
                                        <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#editChapter@(capitulo.Id)">Cancel</button>
                                    </div>
                                </form>
                            </div>

                            <!-- Pages in this chapter -->
                            @if (capitulo.Paginas.Any())
                            {
                                <div class="mt-2">
                                    <small class="text-muted">
                                        Pages: @string.Join(", ", capitulo.Paginas.OrderBy(p => p.NumeroPagina).Select(p => p.NumeroPagina))
                                    </small>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-muted">No chapters have been added yet. Create your first chapter above.</p>
            }
        </div>
    </div>

    <!-- Quick Import Section -->
    @if (Model.Capitulos.Any())
    {
        <div class="card shadow-sm mb-4" style="border: 1px solid var(--border-color); background-color: var(--bg-light);">
            <div class="card-header" style="background-color: var(--bg-darker); color: var(--text-primary); border-bottom: 1px solid var(--border-color);">
                <h6 class="mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom; margin-right: 8px;">
                        <path d="M5.52.359A.5.5 0 0 1 6 0h4a.5.5 0 0 1 .474.658L8.694 6H12.5a.5.5 0 0 1 .395.807l-7 9a.5.5 0 0 1-.873-.454L6.823 9.5H3.5a.5.5 0 0 1-.48-.641l2.5-8.5z"/>
                    </svg>
                    Quick Import Chapter from E-Hentai
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom; margin-right: 4px;">
                                <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                            </svg>
                            Select Chapter
                        </label>
                        <input type="hidden" id="importCapituloId" value="">
                        <div class="dropdown w-100">
                            <button class="btn dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center" type="button" id="importCapituloDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">
                                <span id="importCapituloLabel">Choose a chapter...</span>
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="importCapituloDropdown">
                                @foreach (var capitulo in Model.Capitulos.OrderBy(c => c.NumeroCapitulo))
                                {
                                    <li><a class="dropdown-item chapter-option" href="#" data-value="@capitulo.Id" data-label="@capitulo.NomeExibicao (@capitulo.Paginas.Count page(s))">@capitulo.NomeExibicao (@capitulo.Paginas.Count page(s))</a></li>
                                }
                            </ul>
                        </div>
                        <div class="form-text">Pages will be added to this chapter</div>
                    </div>
                    <div class="col-md-6">
                        <label for="ehentaiChapterUrl" class="form-label fw-semibold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom; margin-right: 4px;">
                                <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
                                <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/>
                            </svg>
                            Gallery URL
                        </label>
                        <div class="input-group">
                            <input type="url" class="form-control" id="ehentaiChapterUrl" placeholder="https://e-hentai.org/g/2431884/7a9b3b6bcc/" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                            <button type="button" class="btn btn-primary" id="btnImportChapter">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom;">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                                Import
                            </button>
                        </div>
                        <div class="form-text">Download pages from E-Hentai gallery</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div id="importChapterProgress" class="mt-3" style="display: none;">
                    <div class="d-flex justify-content-between mb-2">
                        <span id="chapterProgressText" class="fw-semibold" style="color: var(--text-primary);">Initializing...</span>
                        <span id="chapterProgressPercent" class="badge bg-primary">0%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             id="chapterProgressBar"
                             role="progressbar"
                             style="width: 0%;"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100">
                        </div>
                    </div>
                </div>

                <!-- Success/Error Messages -->
                <div id="importChapterMessage" class="mt-3" style="display: none;"></div>
            </div>
        </div>

        <div class="text-center mb-4">
            <div class="position-relative">
                <hr style="border-color: var(--border-color);">
                <span class="position-absolute top-50 start-50 translate-middle px-3" style="background-color: var(--bg-primary); color: var(--text-secondary); font-size: 0.875rem; font-weight: 500;">OR UPLOAD MANUALLY BELOW</span>
            </div>
        </div>
    }

    <!-- Upload Pages Section -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <h5 class="card-title">Upload New Pages</h5>
                    @if (Model.Capitulos.Any())
                    {
                        <form method="post" asp-controller="Admin" asp-action="UploadPages" asp-route-id="@Model.Id" enctype="multipart/form-data">
                            @Html.AntiForgeryToken()
                            <div class="mb-3">
                                <label for="capituloId" class="form-label">Select Chapter</label>
                                <select class="form-select" id="capituloId" name="capituloId" required>
                                    <option value="">Choose a chapter...</option>
                                    @foreach (var capitulo in Model.Capitulos.OrderBy(c => c.NumeroCapitulo))
                                    {
                                        <option value="@capitulo.Id">@capitulo.NomeExibicao (@capitulo.Paginas.Count page(s))</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="paginas" class="form-label">Select pages (multiple files)</label>
                                <input type="file" class="form-control" id="paginas" name="paginas" accept="image/*" multiple required>
                                <div class="form-text">Select multiple image files. Pages will be numbered automatically.</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload</button>
                            <a asp-controller="Admin" asp-action="Index" class="btn btn-secondary">Back</a>
                        </form>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            Please create a chapter first before uploading pages.
                        </div>
                        <a asp-controller="Admin" asp-action="Index" class="btn btn-secondary">Back</a>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">All Pages by Chapter</h5>
                    @if (Model.Capitulos.Any(c => c.Paginas.Any()))
                    {
                        @foreach (var capitulo in Model.Capitulos.OrderBy(c => c.NumeroCapitulo))
                        {
                            @if (capitulo.Paginas.Any())
                            {
                                <div class="mb-3">
                                    <h6 class="text-primary">@capitulo.NomeExibicao</h6>
                                    <div class="list-group">
                                        @foreach (var pagina in capitulo.Paginas.OrderBy(p => p.NumeroPagina))
                                        {
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Page @pagina.NumeroPagina</span>
                                                <form method="post" asp-controller="Admin" asp-action="DeletePage" asp-route-id="@pagina.Id" asp-route-mangaId="@Model.Id" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this page?')">Delete</button>
                                                </form>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    }
                    else
                    {
                        <p class="text-muted">No pages have been added yet.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Chapter dropdown handler
    document.addEventListener('DOMContentLoaded', function() {
        const chapterOptions = document.querySelectorAll('.chapter-option');
        const capituloIdInput = document.getElementById('importCapituloId');
        const capituloLabel = document.getElementById('importCapituloLabel');

        chapterOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const value = this.getAttribute('data-value');
                const label = this.getAttribute('data-label');

                capituloIdInput.value = value;
                capituloLabel.textContent = label;
            });
        });
    });

    document.getElementById('btnImportChapter')?.addEventListener('click', async function() {
        const url = document.getElementById('ehentaiChapterUrl').value.trim();
        const capituloId = document.getElementById('importCapituloId').value;
        const btnImport = this;
        const progressContainer = document.getElementById('importChapterProgress');
        const progressBar = document.getElementById('chapterProgressBar');
        const progressText = document.getElementById('chapterProgressText');
        const progressPercent = document.getElementById('chapterProgressPercent');
        const messageContainer = document.getElementById('importChapterMessage');

        // Validate chapter selection
        if (!capituloId) {
            alert('Please select a chapter first');
            return;
        }

        // Validate URL
        if (!url) {
            alert('Please enter an e-hentai.org URL');
            return;
        }

        if (!url.includes('e-hentai.org/g/') && !url.includes('exhentai.org/g/')) {
            alert('Invalid e-hentai.org URL. Please use a gallery URL like: https://e-hentai.org/g/2431884/7a9b3b6bcc/');
            return;
        }

        // Disable button and show progress
        btnImport.disabled = true;
        btnImport.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Importing...';
        progressContainer.style.display = 'block';
        messageContainer.style.display = 'none';

        // Progress update function
        const updateProgress = (percent, text) => {
            progressBar.style.width = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent);
            progressPercent.textContent = percent + '%';
            progressText.textContent = text;
        };

        try {
            // Step 1: Fetching pages
            updateProgress(10, 'Fetching gallery pages...');
            await new Promise(resolve => setTimeout(resolve, 500));

            updateProgress(20, 'Finding all images...');
            await new Promise(resolve => setTimeout(resolve, 500));

            updateProgress(40, 'Downloading pages (this may take a while)...');

            // Make AJAX call
            const response = await fetch('@Url.Action("ImportChapterFromEHentai", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url, capituloId: capituloId })
            });

            updateProgress(90, 'Processing and saving data...');
            const result = await response.json();

            if (result.success) {
                updateProgress(100, 'Import completed successfully!');

                // Show success message
                messageContainer.className = 'alert alert-success';
                messageContainer.innerHTML = `
                    <div class="d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                        </svg>
                        <div>
                            <strong>Success!</strong> ${result.message}
                            <br><small>Reloading page...</small>
                        </div>
                    </div>
                `;
                messageContainer.style.display = 'block';

                // Reload after 2 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                throw new Error(result.message);
            }

        } catch (error) {
            console.error('Import error:', error);

            // Show error
            progressContainer.style.display = 'none';
            messageContainer.className = 'alert alert-danger';
            messageContainer.innerHTML = `
                <div class="d-flex align-items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                    </svg>
                    <div><strong>Error:</strong> ${error.message || 'Failed to import chapter. Please try again.'}</div>
                </div>
            `;
            messageContainer.style.display = 'block';

            // Re-enable button
            btnImport.disabled = false;
            btnImport.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom;">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Import
            `;
        }
    });
</script>
}

